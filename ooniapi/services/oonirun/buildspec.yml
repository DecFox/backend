version: 0.2
env:
  variables:
    OONI_CODE_PATH: ooniapi/services/oonirun
    DOCKERHUB_SECRET_ID: oonidevops/dockerhub/access_token
    LANG: "en_US.UTF-8"
    LANGUAGE: "en_US.UTF-8"
    LC_CTYPE: "en_US.UTF-8"

phases:
  install:
    runtime-versions:
      python: 3.11
    commands:
      - pip install hatch
      - echo "deb https://apt.postgresql.org/pub/repos/apt $(lsb_release -cs)-pgdg main" > /etc/apt/sources.list.d/pgdg.list
      - wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | apt-key add -
      - apt-get update
      - apt install -y postgresql-16

  pre_build:
    run-as: codebuild-user
    commands:
      - aws --version
      - echo "Logging in to ECR"
      - aws secretsmanager get-secret-value --secret-id $DOCKERHUB_SECRET_ID --query SecretString --output text | docker login --username ooni --password-stdin

  build:
    run-as: codebuild-user
    commands:
      - cd $OONI_CODE_PATH
      - export GIT_FULL_SHA=${CODEBUILD_RESOLVED_SOURCE_VERSION}
      - make test
      - make clean
      - make imagedefinitions.json

artifacts:
  files: imagedefinitions.json
